# Example GitHub Workflow: Automated Issue Triage with Claude Code
#
# To use this workflow:
# 1. Rename to issue-triage.yml (remove .example)
# 2. Add ANTHROPIC_API_KEY to repository secrets
# 3. Customize labels and prompts as needed
#
# This workflow automatically:
# - Analyzes new issues
# - Suggests appropriate labels
# - Adds helpful comments with investigation steps

name: Issue Triage with Claude

on:
  issues:
    types: [opened]

jobs:
  analyze-and-label:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code (when available)
        run: |
          # Note: Update this when Claude Code CLI is publicly available
          echo "Claude Code CLI installation step"
          # npm install -g @anthropic-ai/claude-code

      - name: Analyze Issue
        id: analyze
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_AUTHOR: ${{ github.event.issue.user.login }}
        run: |
          cat > prompt.txt <<'EOF'
          Analyze this GitHub issue for the experimentation platform and provide structured analysis.

          Issue #${{ env.ISSUE_NUMBER }}
          Title: ${{ env.ISSUE_TITLE }}
          Author: ${{ env.ISSUE_AUTHOR }}

          Description:
          ${{ env.ISSUE_BODY }}

          Based on the codebase context, determine:

          1. **Labels** (choose appropriate ones):
             - bug: Code defects or unexpected behavior
             - feature: New functionality requests
             - enhancement: Improvements to existing features
             - documentation: Documentation updates
             - backend: Backend/API changes (FastAPI, database)
             - frontend: Frontend/UI changes (Next.js)
             - lambda: AWS Lambda functions
             - database: Database schema or migrations
             - testing: Test-related changes
             - performance: Performance optimizations
             - security: Security-related issues

          2. **Priority** (P0-P3):
             - P0: Critical, blocks core functionality
             - P1: Important, significant impact
             - P2: Normal priority
             - P3: Low priority, nice to have

          3. **Complexity** (simple/moderate/complex):
             - simple: < 4 hours work
             - moderate: 1-2 days work
             - complex: > 2 days work

          4. **Affected Components**: Specific parts of the codebase

          Return JSON format:
          {
            "labels": ["label1", "label2"],
            "priority": "P1",
            "complexity": "moderate",
            "components": ["backend/api", "database"],
            "reasoning": "Brief explanation"
          }
          EOF

          # Run analysis (placeholder - update when CLI available)
          echo '{"labels":["bug","backend"],"priority":"P2","complexity":"moderate","components":["backend/api"],"reasoning":"API endpoint issue"}' > analysis.json

          # Extract labels for GitHub API
          LABELS=$(cat analysis.json | jq -r '.labels | join(",")')
          echo "labels=$LABELS" >> $GITHUB_OUTPUT

          # Save full analysis
          cat analysis.json > $GITHUB_STEP_SUMMARY

      - name: Apply Labels
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          LABELS="${{ steps.analyze.outputs.labels }}"
          if [ -n "$LABELS" ]; then
            gh issue edit ${{ github.event.issue.number }} --add-label "$LABELS"
          fi

      - name: Add Analysis Comment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ANALYSIS=$(cat analysis.json)
          PRIORITY=$(echo $ANALYSIS | jq -r '.priority')
          COMPLEXITY=$(echo $ANALYSIS | jq -r '.complexity')
          COMPONENTS=$(echo $ANALYSIS | jq -r '.components | join(", ")')
          REASONING=$(echo $ANALYSIS | jq -r '.reasoning')

          gh issue comment ${{ github.event.issue.number }} --body "## ðŸ¤– Automated Analysis

          **Priority**: $PRIORITY
          **Complexity**: $COMPLEXITY
          **Components**: $COMPONENTS

          **Analysis**: $REASONING

          ---
          _Generated by Claude Code automation_"

  suggest-investigation:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate Investigation Steps
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          # Placeholder for Claude analysis
          cat > investigation.md <<'EOF'
          ### ðŸ” Suggested Investigation Steps

          1. Check recent changes in affected files
          2. Review related test coverage
          3. Look for similar issues in the issue tracker
          4. Verify database schema compatibility

          ### ðŸ“ Relevant Files

          - `backend/app/api/v1/endpoints/experiments.py`
          - `backend/app/services/experiment_service.py`

          ### ðŸ”— Related Issues

          Check issues with labels: `backend`, `api`
          EOF

      - name: Add Investigation Comment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "$(cat investigation.md)"
